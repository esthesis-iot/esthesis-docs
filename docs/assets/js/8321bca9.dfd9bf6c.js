"use strict";(self.webpackChunkesthesis_core=self.webpackChunkesthesis_core||[]).push([[36884],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>g});var i=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)n=a[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=i.createContext({}),p=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return i.createElement(l.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},h=i.forwardRef((function(e,t){var n=e.components,r=e.mdxType,a=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=p(n),h=r,g=c["".concat(l,".").concat(h)]||c[h]||d[h]||a;return n?i.createElement(g,o(o({ref:t},u),{},{components:n})):i.createElement(g,o({ref:t},u))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var a=n.length,o=new Array(a);o[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:r,o[1]=s;for(var p=2;p<a;p++)o[p]=n[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}h.displayName="MDXCreateElement"},38046:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>p});var i=n(87462),r=(n(67294),n(3905));const a={},o="Working with a private Container Registry",s={unversionedId:"developers-guide/Working with a private Container Registry",id:"version-3.0.49/developers-guide/Working with a private Container Registry",title:"Working with a private Container Registry",description:"When working in dev mode you run all services in your local machine, so there is no need to",source:"@site/versioned_docs/version-3.0.49/07-developers-guide/03-Working with a private Container Registry.md",sourceDirName:"07-developers-guide",slug:"/developers-guide/Working with a private Container Registry",permalink:"/docs/developers-guide/Working with a private Container Registry",draft:!1,tags:[],version:"3.0.49",sidebarPosition:3,frontMatter:{},sidebar:"sidebar",previous:{title:"Working with Helm charts",permalink:"/docs/developers-guide/Working with Helm charts"},next:{title:"Developing backend services",permalink:"/docs/developers-guide/Developing backend services"}},l={},p=[{value:"Building and pushing images",id:"building-and-pushing-images",level:2},{value:"Using the private registry in testing a production-like installation",id:"using-the-private-registry-in-testing-a-production-like-installation",level:2},{value:"Deploying Dataflows",id:"deploying-dataflows",level:2}],u={toc:p},c="wrapper";function d(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,i.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"working-with-a-private-container-registry"},"Working with a private Container Registry"),(0,r.kt)("p",null,"When working in dev mode you run all services in your local machine, so there is no need to\npush images to a container registry. However, when you want to test your changes in a production-like\nKubernetes environment you need to push your images to a container registry, so that your\nproduction-like Kubernetes cluster can pull them from. Considering esthesis CORE maintains many\nservices with support of multiple architectures, pushing all those images to e.g. Docker Hub can take a\nlong time."),(0,r.kt)("p",null,"To speed up the process you can use the private Container Registry provided by esthesis dependencies\nHelm Chart.\nThe chart will deploy a private registry in your Kubernetes cluster as a NodePort Service. The service\nwill be assigned a random port, so you should take note of the IP of your worker node as well as the\nassigned port. You can then use the ",(0,r.kt)("inlineCode",{parentName:"p"},"publish.sh")," script to build and push your images to the private\nregistry."),(0,r.kt)("h2",{id:"building-and-pushing-images"},"Building and pushing images"),(0,r.kt)("p",null,"When using the ",(0,r.kt)("inlineCode",{parentName:"p"},"publish.sh")," script to prepare your images, you can define the ",(0,r.kt)("inlineCode",{parentName:"p"},"ESTHESIS_REGISTRY_URL"),"\nenvironment variable to point to a private registry. This variable should point to the IP address,\nport, and user/project name of your private registry, for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"ESTHESIS_REGISTRY_TYPE=open ESTHESIS_REGISTRY_URL=192.168.50.211:5000/esthesis ./publish.sh\n")),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"192.168.50.211:5000 is used as an example in all following configurations too, change it according\nto your own setup.")),(0,r.kt)("p",null,"Note that since your private registry will be insecure, you need to add it to the insecure registries\nlist. To do so, create a file ",(0,r.kt)("inlineCode",{parentName:"p"},"buildkit.toml")," and place it in the same level as the ",(0,r.kt)("inlineCode",{parentName:"p"},"publish.sh")," script.\nThe contents of this file should be similar to:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-toml"},'insecure-entitlements = [ "network.host", "security.insecure"]\n[registry."192.168.50.211:5000"]\n  http = true\n  insecure = true\n')),(0,r.kt)("p",null,"In case you are pushing to a private registry requiring authentication, you can define the following\nenvironment variables:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"ESTHESIS_REGISTRY_TYPE=auth\nESTHESIS_REGISTRY_USERNAME= <username>\nESTHESIS_REGISTRY_PASSWORD= <password>\n")),(0,r.kt)("h2",{id:"using-the-private-registry-in-testing-a-production-like-installation"},"Using the private registry in testing a production-like installation"),(0,r.kt)("p",null,"When testing a production-like installation, you can configure the Helm charts to use the images from\nyour private registry instead of e.g. Docker Hub. To do so, you can define the ",(0,r.kt)("inlineCode",{parentName:"p"},"ESTHESIS_REGISTRY_URL"),"\nenvironment variable to point to the private registry. This variable should point to the IP address,\nport, and user/project name of your private registry, for example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"ESTHESIS_REGISTRY_URL=192.168.50.211:5000/esthesis helmfile sync -n esthesis\n")),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("ol",{parentName:"admonition"},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"When using the Helm charts without the ",(0,r.kt)("inlineCode",{parentName:"p"},"-env dev")," flag, the charts will automatically\nuse multi-node deployments. If you are testing in a single-node Kubernetes cluster, you need to also\ndefine ",(0,r.kt)("inlineCode",{parentName:"p"},"ESTHESIS_SINGLE_NODE=true")," environmental variable.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If you want to use the Helm charts, locally available to your machine, while still deploying a\nproduction-level setup, you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"ESTHESIS_LOCAL_CHARTS=true")," environmental variable.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"If while working with a private you are also deploying on a Kubernetes cluster thart does not\nhave access to proper certificates, you can also set ",(0,r.kt)("inlineCode",{parentName:"p"},"OIDC_TLS_VERIFICATION=none")," while deploying\nthe Helm charts.")))),(0,r.kt)("h2",{id:"deploying-dataflows"},"Deploying Dataflows"),(0,r.kt)("p",null,'To use a private registry when deploying a Dataflow, you can use the "Custom Docker Registry" field\nin the Dataflow definition screen specifying the same registry coordinates you used when building\nthe services, for example ',(0,r.kt)("inlineCode",{parentName:"p"},"192.168.50.211:5000/esthesis"),". Similarly to when building the services,\nyou should configure your Kubernetes distribution to be able to pull from that insecure registry.\nThe exact way this is done depends on the Kubernetes distribution you are using."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"K3S:\\\nEdit or create ",(0,r.kt)("inlineCode",{parentName:"li"},"/etc/rancher/k3s/registries.yaml")," and add the following lines:",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'mirrors:\n"192.168.50.211:5000":\n  endpoint:\n    - "http://192.168.50.211:5000"\n')),"Restart the K3S service with ",(0,r.kt)("inlineCode",{parentName:"li"},"sudo systemctl restart k3s.service"),".")),(0,r.kt)("p",null,"Depending on your Kubernetes distribution, you might be able to get away with adding the registry to\nthe insecure registries list by replacing the IP address of your registry with ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost"),", for\nexample ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost:32000/esthesis"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"")))}d.isMDXComponent=!0}}]);