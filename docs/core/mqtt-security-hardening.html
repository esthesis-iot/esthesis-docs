<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="soft" data-primary-color="#059999" data-link-color="#059999"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2024-12-10T07:56:41.976932202"><title>MQTT security hardening | esthesis CORE - Documentation</title><script type="application/json" id="virtual-toc-data">[{"id":"create-a-certificate-authority-and-a-certificate","level":0,"title":"Create a Certificate Authority and a Certificate","anchor":"#create-a-certificate-authority-and-a-certificate"},{"id":"redeploy-the-helm-chart-enabling-tls","level":0,"title":"Redeploy the Helm chart enabling TLS","anchor":"#redeploy-the-helm-chart-enabling-tls"},{"id":"warnings","level":0,"title":"Warnings","anchor":"#warnings"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b419/app.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="16x16" href="images/logo.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="MQTT security hardening | esthesis CORE - Documentation"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="esthesis CORE - Documentation Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/mqtt-security-hardening.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="MQTT security hardening | esthesis CORE - Documentation"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/mqtt-security-hardening.html#webpage",
    "url": "writerside-documentation/mqtt-security-hardening.html",
    "name": "MQTT security hardening | esthesis CORE - Documentation",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "esthesis CORE - Documentation Help"
}</script><!-- End Schema.org --></head><body data-id="mqtt-security-hardening" data-main-title="MQTT security hardening" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Startup guide"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>esthesis CORE - Documentation  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="mqtt-security-hardening" id="mqtt-security-hardening.md">MQTT security hardening</h1><p id="z185zsn_3">The default Helm charts for esthesis dependencies deploy an MQTT broker with no security configured. This may be convenient to make sure everything works in your environment, however by no means this is a production-ready setup. As esthesis uses the topic names to connect device IDs with the actual devices managed in the system, it is of paramount importance to enable security in MQTT before you expose your installation outside a controlled network.</p><p id="z185zsn_4">The following instructions show you how you can enable certificate-based authentication using Eclipse Mosquitto, which is the MQTT broker being used when you set up esthesis using the provided Helm charts.</p><section class="chapter"><h2 id="create-a-certificate-authority-and-a-certificate" data-toc="create-a-certificate-authority-and-a-certificate">Create a Certificate Authority and a Certificate</h2><p id="z185zsn_8">To enable certificate-based authentication and mutual TLS, you need to create a Certificate Authority (CA) and a server certificate.</p><p id="z185zsn_9">The CA will be responsible to sign the server certificate, and should be the same CA that signs the certificates used by the devices to connect to the MQTT broker.</p><p id="z185zsn_10">The server certificate will be used by the MQTT broker to establish a TLS connections with the devices.</p><section class="chapter"><h3 id="create-a-certificate-authority" data-toc="create-a-certificate-authority">Create a Certificate Authority</h3><p id="z185zsn_14">To create a Certificate Authority, go to Key Management &gt; CAs and click on the &quot;Create&quot; button. If you have already configured a CA before, you can skip this part. Make sure the CA you create here is the one set as the Root CA under Settings &gt; Security.</p></section><section class="chapter"><h3 id="create-a-server-certificate" data-toc="create-a-server-certificate">Create a server Certificate</h3><p id="z185zsn_15">You need to create a certificate to be used by the MQTT server to establish TLS. To create a Certificate, go to Key Management &gt; Certificates and click on the &quot;Create&quot; button. Pay attention to the following points:</p><ol class="list _decimal" id="z185zsn_16" type="1"><li class="list__item" id="z185zsn_17"><p>The certificate should be signed by the CA you created above.</p></li><li class="list__item" id="z185zsn_18"><p>The CN of the certificate should match the domain where the MQTT server is accessible from your devices' perspective. You can add additional domains as SANs (for example, the domain name of the service under which the MQTT server is accessible from within the cluster, i.e. mosquitto).</p></li></ol></section><section class="chapter"><h3 id="download-the-ca-and-the-server-certificate" data-toc="download-the-ca-and-the-server-certificate">Download the CA and the Server Certificate</h3><p id="z185zsn_19">Download the private key and the certificate for the server certificate you created above and the certificate for the CA.</p></section></section><section class="chapter"><h2 id="redeploy-the-helm-chart-enabling-tls" data-toc="redeploy-the-helm-chart-enabling-tls">Redeploy the Helm chart enabling TLS</h2><p id="z185zsn_20">Go to the location where you deployed the esthesis dependencies via executing <code class="code" id="z185zsn_23">helmfile sync</code> and add the following environment variables:</p><div class="code-block" data-lang="bash">
export MOSQUITTO_MUTUAL_TLS=true
export MOSQUITTO_CA_CERT=$(cat ca.crt | base64)
export MOSQUITTO_SERVER_CERT=$(cat server.crt | base64)
export MOSQUITTO_SERVER_KEY=$(cat server.key | base64)
</div><aside class="prompt" data-type="note" data-title="" id="z185zsn_22"><ol class="list _decimal" id="z185zsn_24" type="1"><li class="list__item" id="z185zsn_25"><p id="z185zsn_28">Replace the names of ca.crt, server.crt and server.key with the files you downloaded above.</p></li><li class="list__item" id="z185zsn_26"><p id="z185zsn_29">During the deployment of the supporting infrastructure you, probably, had to define an array of environment variables to be used by the Helm charts. Do not forget to re-specify these variables before you re-run the <code class="code" id="z185zsn_30">helmfile sync</code> command here, otherwise the deployment might fail or have unexpected results.</p></li><li class="list__item" id="z185zsn_27"><p id="z185zsn_31">The name of the user specified by <code class="code" id="z185zsn_32">MOSQUITTO_SUPER_USER</code> (in your environment variables while deploying the supporting infrastructure) will be the &quot;superuser&quot; for the MQTT, i.e. a user that can subscribe and publish to/from any topic. Create a separate certificate for this user, having the Common Name set to the same name as the one you specified by <code class="code" id="z185zsn_33">MOSQUITTO_SUPER_USER</code> (if you did not specify a value for <code class="code" id="z185zsn_34">MOSQUITTO_SUPER_USER</code>, the default value is 'esthesis').</p></li></ol></aside></section><section class="chapter"><h2 id="warnings" data-toc="warnings">Warnings</h2><aside class="prompt" data-type="warning" data-title="" id="z185zsn_35"><section class="chapter"><h3 id="losing-connectivity-with-your-devices" data-toc="losing-connectivity-with-your-devices">Losing connectivity with your devices</h3><p>Before you apply the above procedure, make sure devices already provisioned to esthesis CORE have been issued with a certificate signed by the CA used above. Otherwise, they will lose connectivity to the MQTT broker. </p><p id="z185zsn_38">In addition, since the MQTT broker will no longer accept non-TLS connections, you need to update the URL of the MQTT broker used by the devices to start with <code class="code" id="z185zsn_39">ssl://</code> instead of <code class="code" id="z185zsn_40">tcp://</code>. For the time being, this is a manual process by editing the <code class="code" id="z185zsn_41">esthesis.properties</code> file on the devices, changing the value of <code class="code" id="z185zsn_42">MqttServer</code> property.</p></section><section class="chapter"><h3 id="dataflows-failing-to-connect" data-toc="dataflows-failing-to-connect">Dataflows failing to connect</h3><p>If you have configured a dataflow that accesses the MQTT broker, you need to update it to point to the TLS URL of the MQTT broker. In addition, you need to update the dataflow to use a certificate to identify itself to the MQTT broker. </p><p id="z185zsn_43">Be careful which certificate you will use. Dataflows accessing the MQTT broker, usually, require full-access, that means to be able to subscribe and publish to/from any topic. If you have used the provided Mosquitto configuration, you need to use the certificate of the &quot;superuser&quot; you created while hardening the security of the MQTT broker.</p></section></aside></section><div class="last-modified">Last modified: 10 December 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="registering-a-test-device.html" class="navigation-links__prev">Registering a test device</a><a href="tags.html" class="navigation-links__next">Tags</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b419/app.js"></script></body></html>