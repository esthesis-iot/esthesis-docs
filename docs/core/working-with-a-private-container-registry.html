<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="soft" data-primary-color="#059999" data-link-color="#059999"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2025-01-15T15:21:10.753081852"><title>Working with a private Container Registry | esthesis CORE - Documentation</title><script type="application/json" id="virtual-toc-data">[{"id":"building-and-pushing-images","level":0,"title":"Building and pushing images","anchor":"#building-and-pushing-images"},{"id":"using-the-private-registry-in-testing-a-production-like-installation","level":0,"title":"Using the private registry in testing a production-like installation","anchor":"#using-the-private-registry-in-testing-a-production-like-installation"},{"id":"deploying-dataflows","level":0,"title":"Deploying Dataflows","anchor":"#deploying-dataflows"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b419/app.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="16x16" href="images/logo.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Working with a private Container Registry | esthesis CORE - Documentation"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="esthesis CORE - Documentation Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/working-with-a-private-container-registry.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Working with a private Container Registry | esthesis CORE - Documentation"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/working-with-a-private-container-registry.html#webpage",
    "url": "writerside-documentation/working-with-a-private-container-registry.html",
    "name": "Working with a private Container Registry | esthesis CORE - Documentation",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "esthesis CORE - Documentation Help"
}</script><!-- End Schema.org --></head><body data-id="working-with-a-private-container-registry" data-main-title="Working with a private Container Registry" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Developers Guide"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>esthesis CORE - Documentation  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="working-with-a-private-container-registry" id="working-with-a-private-container-registry.md">Working with a private Container Registry</h1><p id="plc08o_3">When working in dev mode you run all services in your local machine, so there is no need to push images to a container registry. However, when you want to test your changes in a production-like Kubernetes environment you need to push your images to a container registry, so that your production-like Kubernetes cluster can pull them from. Considering esthesis CORE maintains many services with support of multiple architectures, pushing all those images to e.g. Docker Hub can take a long time.</p><p id="plc08o_4">To speed up the process you can use the private Container Registry provided by esthesis dependencies Helm Chart. The chart will deploy a private registry in your Kubernetes cluster as a NodePort Service. The service will be assigned a random port, so you should take note of the IP of your worker node as well as the assigned port. You can then use the <code class="code" id="plc08o_8">publish.sh</code> script to build and push your images to the private registry.</p><section class="chapter"><h2 id="building-and-pushing-images" data-toc="building-and-pushing-images">Building and pushing images</h2><p id="plc08o_9">When using the <code class="code" id="plc08o_16">publish.sh</code> script to prepare your images, you can define the <code class="code" id="plc08o_17">ESTHESIS_REGISTRY_URL</code> environment variable to point to a private registry. This variable should point to the IP address, port, and user/project name of your private registry, for example:</p><div class="code-block" data-lang="bash">
ESTHESIS_REGISTRY_TYPE=open ESTHESIS_REGISTRY_URL=192.168.50.211:5000/esthesis ./publish.sh
</div><aside class="prompt" data-type="tip" data-title="" id="plc08o_11"><p>192.168.50.211:5000 is used as an example in all following configurations too, change it according to your own setup.</p></aside><p id="plc08o_12">Note that since your private registry will be insecure, you need to add it to the insecure registries list. To do so, create a file <code class="code" id="plc08o_18">buildkit.toml</code> and place it in the same level as the <code class="code" id="plc08o_19">publish.sh</code> script. The contents of this file should be similar to:</p><div class="code-block" data-lang="none">
insecure-entitlements = [ &quot;network.host&quot;, &quot;security.insecure&quot;]
[registry.&quot;192.168.50.211:5000&quot;]
  http = true
  insecure = true
</div><p id="plc08o_14">In case you are pushing to a private registry requiring authentication, you can define the following environment variables:</p><div class="code-block" data-lang="bash">
ESTHESIS_REGISTRY_TYPE=auth
ESTHESIS_REGISTRY_USERNAME=&lt;username&gt;
ESTHESIS_REGISTRY_PASSWORD=&lt;password&gt;
</div></section><section class="chapter"><h2 id="using-the-private-registry-in-testing-a-production-like-installation" data-toc="using-the-private-registry-in-testing-a-production-like-installation">Using the private registry in testing a production-like installation</h2><p id="plc08o_20">When testing a production-like installation, you can configure the Helm charts to use the images from your private registry instead of e.g. Docker Hub. To do so, you can define the <code class="code" id="plc08o_23">ESTHESIS_REGISTRY_URL</code> environment variable to point to the private registry. This variable should point to the IP address, port, and user/project name of your private registry, for example:</p><div class="code-block" data-lang="bash">
ESTHESIS_REGISTRY_URL=192.168.50.211:5000/esthesis helmfile sync -n esthesis
</div><aside class="prompt" data-type="tip" data-title="" id="plc08o_22"><ol class="list _decimal" id="plc08o_24" type="1"><li class="list__item" id="plc08o_25"><p id="plc08o_28">When using the Helm charts without the <code class="code" id="plc08o_29">-env dev</code> flag, the charts will automatically use multi-node deployments. If you are testing in a single-node Kubernetes cluster, you need to also define <code class="code" id="plc08o_30">ESTHESIS_SINGLE_NODE=true</code> environmental variable.</p></li><li class="list__item" id="plc08o_26"><p id="plc08o_31">If you want to use the Helm charts, locally available to your machine, while still deploying a production-level setup, you can use the <code class="code" id="plc08o_32">ESTHESIS_LOCAL_CHARTS=true</code> environmental variable.</p></li><li class="list__item" id="plc08o_27"><p id="plc08o_33">If while working with a private you are also deploying on a Kubernetes cluster thart does not have access to proper certificates, you can also set <code class="code" id="plc08o_34">OIDC_TLS_VERIFICATION=none</code> while deploying the Helm charts.</p></li></ol></aside></section><section class="chapter"><h2 id="deploying-dataflows" data-toc="deploying-dataflows">Deploying Dataflows</h2><p id="plc08o_35">To use a private registry when deploying a Dataflow, you can use the &quot;Custom Docker Registry&quot; field in the Dataflow definition screen specifying the same registry coordinates you used when building the services, for example <code class="code" id="plc08o_38">192.168.50.211:5000/esthesis</code>. Similarly to when building the services, you should configure your Kubernetes distribution to be able to pull from that insecure registry. The exact way this is done depends on the Kubernetes distribution you are using.</p><ul class="list _bullet" id="plc08o_36"><li class="list__item" id="plc08o_39"><p id="plc08o_40">K3S: <br> Edit or create <code class="code" id="plc08o_44">/etc/rancher/k3s/registries.yaml</code> and add the following lines:</p><div class="code-block" data-lang="yaml">
	mirrors:
&quot;192.168.50.211:5000&quot;:
endpoint:
  - &quot;http://192.168.50.211:5000&quot;
</div><p id="plc08o_42">Restart the K3S service with <code class="code" id="plc08o_45">sudo systemctl restart k3s.service</code>.</p></li></ul><p id="plc08o_37">Depending on your Kubernetes distribution, you might be able to get away with adding the registry to the insecure registries list by replacing the IP address of your registry with <code class="code" id="plc08o_46">localhost</code>, for example <code class="code" id="plc08o_47">localhost:32000/esthesis</code>.</p></section><div class="last-modified">Last modified: 15 January 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="working-with-helm-charts.html" class="navigation-links__prev">Working with Helm charts</a><a href="developing-backend-services.html" class="navigation-links__next">Developing backend services</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b419/app.js"></script></body></html>