<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="soft" data-primary-color="#059999" data-link-color="#059999"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="built-on" content="2024-10-15T09:16:16.377108879"><title>Inter-service notifications | esthesis CORE - Documentation</title><script type="application/json" id="virtual-toc-data">[{"id":"standardising-components-and-actions","level":0,"title":"Standardising components and actions","anchor":"#standardising-components-and-actions"},{"id":"the-standard-message","level":0,"title":"The standard message","anchor":"#the-standard-message"},{"id":"sending-notifications","level":0,"title":"Sending notifications","anchor":"#sending-notifications"},{"id":"receiving-notifications","level":0,"title":"Receiving notifications","anchor":"#receiving-notifications"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b419/app.css" rel="stylesheet"><link rel="icon" type="image/png" sizes="16x16" href="images/logo.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Inter-service notifications | esthesis CORE - Documentation"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="esthesis CORE - Documentation Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/inter-service-notifications.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Inter-service notifications | esthesis CORE - Documentation"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/inter-service-notifications.html#webpage",
    "url": "writerside-documentation/inter-service-notifications.html",
    "name": "Inter-service notifications | esthesis CORE - Documentation",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "esthesis CORE - Documentation Help"
}</script><!-- End Schema.org --></head><body data-id="inter-service-notifications" data-main-title="Inter-service notifications" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="Developers Guide"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>esthesis CORE - Documentation  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="inter-service-notifications" id="inter-service-notifications.md">Inter-service notifications</h1><p id="-wtn5cg_3">In a fully distributed microservices system, like esthesis CORE, it is often neccessary a service to be notified of events that occur in other services. For example, when a device is deleted from the system, it might be necessary to remove the history of commands that were sent to it.</p><p id="-wtn5cg_4">In esthesis CORE, we use a Kafka-based mechanism to notify services of events that occur in other services. To facilitate and standardise the use of this mechanism, we have created a library named <code class="code" id="-wtn5cg_9">utl-kafka-notifications</code>. The aim of this library is not only to provide utility code when you want to send and receive notifications, but also to provide a standardised way of doing so.</p><section class="chapter"><h2 id="standardising-components-and-actions" data-toc="standardising-components-and-actions">Standardising components and actions</h2><p id="-wtn5cg_10">The names of the components that can participate in the notification mechanism are defined in <a href="https://github.com/esthesis-iot/esthesis-platform/blob/main/esthesis-core/esthesis-core-backend/util/utl-kafka-notifications/utl-kafka-notifications-common/src/main/java/esthesis/util/kafka/notifications/common/KafkaNotificationsConstants.java" id="-wtn5cg_13" data-external="true" rel="noopener noreferrer">KafkaNotificationsConstants.java</a> file. This class is always work in progress, as we keep adding components and event types to it, so if the component, or action, you are working with is not included, you can extend it appropriately.</p><p id="-wtn5cg_11">There are three different <code class="code" id="-wtn5cg_14">enum</code> classes that you can extend:</p><ol class="list _decimal" id="-wtn5cg_12" type="1"><li class="list__item" id="-wtn5cg_15"><p><code class="code" id="-wtn5cg_18">Component</code>: This class defines the components that can participate in the notification mechanism. You should add a new entry representing your component.</p></li><li class="list__item" id="-wtn5cg_16"><p><code class="code" id="-wtn5cg_19">Subject</code>: This class defines the subject of the component being targeted by the message. For example, the Device component may publish messages with different subjects to represent the different types of the underlying object types it manages. For most components, the Subject name will be the same as the Component name, especially considering the narrow scope of each microservice in esthesis CORE.</p></li><li class="list__item" id="-wtn5cg_17"><p><code class="code" id="-wtn5cg_20">Action</code>: This class defines the action that was performed which triggered the message. Try to reuse the existing actions and only define new action types when absolutely necessary.</p></li></ol></section><section class="chapter"><h2 id="the-standard-message" data-toc="the-standard-message">The standard message</h2><p id="-wtn5cg_21">For components to be able to understand messages sent by other components, all messages are published as an <a href="https://github.com/esthesis-iot/esthesis-platform/blob/main/esthesis-core/esthesis-core-backend/util/utl-kafka-notifications/utl-kafka-notifications-common/src/main/java/esthesis/util/kafka/notifications/common/AppMessage.java" id="-wtn5cg_22" data-external="true" rel="noopener noreferrer">AppMessage</a> class. <code class="code" id="-wtn5cg_23">AppMessage</code> encapsulates the information defined in <code class="code" id="-wtn5cg_24">KafkaNotificationsConstants</code> while also providing a custom payload attribute.</p></section><section class="chapter"><h2 id="sending-notifications" data-toc="sending-notifications">Sending notifications</h2><p id="-wtn5cg_25">To facilitate sending notifications from your components we have implemented the <a href="https://github.com/esthesis-iot/esthesis-platform/blob/main/esthesis-core/esthesis-core-backend/util/utl-kafka-notifications/utl-kafka-notifications-outgoing/src/main/java/esthesis/util/kafka/notifications/outgoing/KafkaNotification.java" id="-wtn5cg_30" data-external="true" rel="noopener noreferrer">KafkaNotification</a> annotation. The annotation should be used as a method-level annotation, and it will automatically publish a notification message to Kafka in case your method is executed successfully. The annotation is processed by <a href="https://github.com/esthesis-iot/esthesis-platform/blob/main/esthesis-core/esthesis-core-backend/util/utl-kafka-notifications/utl-kafka-notifications-outgoing/src/main/java/esthesis/util/kafka/notifications/outgoing/KafkaNotificationInterceptor.java" id="-wtn5cg_31" data-external="true" rel="noopener noreferrer">KafkaNotificationInterceptor</a>.</p><p id="-wtn5cg_26">The annotation has the following attributes:</p><ol class="list _decimal" id="-wtn5cg_27" type="1"><li class="list__item" id="-wtn5cg_32"><p><code class="code" id="-wtn5cg_38">component</code>: The component that is sending the notification.</p></li><li class="list__item" id="-wtn5cg_33"><p><code class="code" id="-wtn5cg_39">subject</code>: The subject of the notification.</p></li><li class="list__item" id="-wtn5cg_34"><p><code class="code" id="-wtn5cg_40">action</code>: The action that triggered the notification.</p></li><li class="list__item" id="-wtn5cg_35"><p><code class="code" id="-wtn5cg_41">comment</code>: A comment that can be used to provide more information about the notification.</p></li><li class="list__item" id="-wtn5cg_36"><p><code class="code" id="-wtn5cg_42">idParamOrder</code>: The order of the parameter that contains the ID of the object for the notification. This parameter starts at 0 to indicate the first parameter of the method. Make sure that if your method's parameter order changes, you update this attribute accordingly.</p></li><li class="list__item" id="-wtn5cg_37"><p><code class="code" id="-wtn5cg_43">idParamRegEx</code>: A regular expression that is used to extract the ID of the object for the notification. If used, this attribute takes precedence over <code class="code" id="-wtn5cg_44">idParamOrder</code>. This parameter is useful in cases where the only argument to a method is a complex object that contains the ID of the object for the notification. See how it is used in <code class="code" id="-wtn5cg_45">register</code> method in <a href="https://github.com/esthesis-iot/esthesis-platform/blob/main/esthesis-core/esthesis-core-backend/services/srv-device/srv-device-impl/src/main/java/esthesis/services/device/impl/service/DeviceRegistrationService.java" id="-wtn5cg_46" data-external="true" rel="noopener noreferrer">DeviceRegistrationService.java</a> as an example.</p></li></ol><section class="chapter"><h3 id="setup-sending" data-toc="setup-sending">Setup (sending)</h3><p id="-wtn5cg_47">To be able to send notification using the above mechanism, you need to set up in your component's applications YAML the following:</p><ul class="list _bullet" id="-wtn5cg_48"><li class="list__item" id="-wtn5cg_49"><p>The <code class="code" id="-wtn5cg_51">kafka.bootstrap.servers</code> property, to connect your component to the Kafka broker.</p></li><li class="list__item" id="-wtn5cg_50"><p>The <code class="code" id="-wtn5cg_52">mp.messaging.outgoing.esthesis-app-out.topic</code> property set to <code class="code" id="-wtn5cg_53">esthesis-app</code>.</p></li></ul></section><section class="chapter"><h3 id="example" data-toc="example">Example</h3><p id="-wtn5cg_54">Let us see how this works taking <a href="https://github.com/esthesis-iot/esthesis-platform/blob/7cb8c453e2c507ab8c90b5d47ae56e14b8aa158d/esthesis-core/esthesis-core-backend/services/srv-device/srv-device-impl/src/main/java/esthesis/services/device/impl/service/DeviceService.java#L219" id="-wtn5cg_58" data-external="true" rel="noopener noreferrer">DeviceService.java</a> as an example:</p><div class="code-block" data-lang="none">
@KafkaNotification(component = Component.DEVICE, subject = Subject.DEVICE,
	action = Action.DELETE, idParamOrder = 0, payload = &quot;Device ID&quot;)
public boolean deleteById(String deviceId) {
		// ...
}
</div><p id="-wtn5cg_56">Once <code class="code" id="-wtn5cg_59">deleteById</code> is executed successfully, a notification message will be published to Kafka with the following attributes:</p><ol class="list _decimal" id="-wtn5cg_57" type="1"><li class="list__item" id="-wtn5cg_60"><p><code class="code" id="-wtn5cg_65">component</code>: <code class="code" id="-wtn5cg_66">Component.DEVICE</code></p></li><li class="list__item" id="-wtn5cg_61"><p><code class="code" id="-wtn5cg_67">subject</code>: <code class="code" id="-wtn5cg_68">Subject.DEVICE</code></p></li><li class="list__item" id="-wtn5cg_62"><p><code class="code" id="-wtn5cg_69">action</code>: <code class="code" id="-wtn5cg_70">Action.DELETE</code></p></li><li class="list__item" id="-wtn5cg_63"><p><code class="code" id="-wtn5cg_71">msgId</code>: A UUID created automatically.</p></li><li class="list__item" id="-wtn5cg_64"><p><code class="code" id="-wtn5cg_72">targetId</code>: The value of <code class="code" id="-wtn5cg_73">deviceId</code>.</p></li></ol></section></section><section class="chapter"><h2 id="receiving-notifications" data-toc="receiving-notifications">Receiving notifications</h2><p id="-wtn5cg_74">To receive the notifications generated with the above mechanism, you can use the built-in Kafka integration of Quarkus. To keep notification handlers consistent between the different components of the platform, please create a <code class="code" id="-wtn5cg_76">notifications</code> package, with one or more notifications handlers inside. You can find an example notification handler in <a href="https://github.com/esthesis-iot/esthesis-platform/blob/main/esthesis-core/esthesis-core-backend/services/srv-device/srv-device-impl/src/main/java/esthesis/services/device/impl/notifications/NotificationsHandler.java" id="-wtn5cg_77" data-external="true" rel="noopener noreferrer">NotificationsHandler.java</a>.</p><section class="chapter"><h3 id="setup-receiving" data-toc="setup-receiving">Setup (receiving)</h3><p id="-wtn5cg_78">To be able to receive notifications using the above mechanism, you need to set up in your component's applications YAML the following:</p><ul class="list _bullet" id="-wtn5cg_79"><li class="list__item" id="-wtn5cg_80"><p>The <code class="code" id="-wtn5cg_82">kafka.bootstrap.servers</code> property, to connect your component to the Kafka broker.</p></li><li class="list__item" id="-wtn5cg_81"><p>The <code class="code" id="-wtn5cg_83">mp.messaging.incoming.esthesis-app-in.topic</code> property set to <code class="code" id="-wtn5cg_84">esthesis-app</code>.</p></li></ul></section></section><div class="last-modified">Last modified: 15 October 2024</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="developing-esthesis-device-agent.html" class="navigation-links__prev">Developing esthesis Device Agent</a><a href="caching.html" class="navigation-links__next">Redis cache</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b419/app.js"></script></body></html>