= esthesis IoT - Device Agent Guide
Doc Writer <esthesis@eurodyn.com>
:toc:
:toclevels: 2
:homepage: https://esthesis.com
:icons: font
:sectanchors:
:sectlinks:

The device agent is the piece of software that runs in your devices allowing you to seamlessly connect and control them from _esthesis_ platform. _esthesis_ provides a device agent that you can use right of the box to interconnect any device capable of running Java.
In addition, the device agent is provided as a multiarch Docker Container (https://hub.docker.com/repository/docker/esthesisiot/esthesis-device).

This section presents the functionality as well as the configuration options of the device agent.

== Installation

The device agent comes in the form of a self-contained Java JAR file.
The JAR file encapsulates all the runtime dependencies needed, so you can execute the agent just by obtaining the
`esthesis-device.jar` file.

=== In a JRE environment

The device agent can be executed in your device using a command similar to:

```
hardwareId=device1 \
storageRoot="$(echo ~$USER)/.esthesis" \
registrationUrl=http://my-esthesis-host \
java -jar target/esthesis-device.jar
```

=== Via Docker

The device agent is also available as a Docker container at
https://hub.docker.com/repository/docker/esthesisiot/esthesis-device.

You can startup a device agent Docker container as:

```

```

== Configuration

The device agent comes with a plethora of configuration options to accommodate different hardware and deployments as presented next.
Mandatory parameters for the device agent to bootup properly are denoted with [red]#*#.
Values in **bold** indicate default values.

.Commonly used parameters
[cols="1,^,1"]
|===
|Parameter |Value |Description

|hardwareId [red]#*#
|Alphanumeric
|An ID that uniquely identifies this device. See also <<_hardware_ids>>.

|pauseStartup
|true, **false**
|A flag indicating whether the device should start paused. A paused device requires a keyboard input
to resume booting, useful when debugging devices.

|provisioningForkType
|**soft**, hard
|A provisioning package contains a script that will be executed by the agent in order to
initiate the actual provisioning process. This flag defines how such execution will take place:

 soft: The script is called as a child process, controlled by the runtime agent. As soon as the
       agent terminates, the provisioning script terminates too.

 hard: The script is called as an independent process, not controlled by the runtime agent.

|provisioningPostHook
|
|The script to be called after a provisioning package is downloaded.
The script is handed the following parameters:

1. The full pathname to the provisioning package.

2. Whether this is an initial provisioning or not (as a true/false value).

|provisioningRoot
|If empty, $storageRoot/provisioning
|The root folder to storeEntity remotely retrieved provisioning packages.

|provisioningTempRoot
|If empty, $storageRoot/provisioning/.tmp
|The root folder to temporarily download a remotely retrieved provisioning packages. Once the
package is downloaded, it is moved to provisioningRoot.

|validateProvisioningChecksum
|**true**, false
|A flag indicating whether the agent should validate the checksum of the incoming provisiong
package.

|rebootCommand
|
|The command to be executed to reboot the device.

|registrationUrl
|
|The URL of the esthesis platform with which the device will attempt to register with. For example,
'http://my-esthesis-host.com'.

|secureStorageRoot
|If empty, $storageRoot
|The root folder under which secure persistent storage is provided.

|storageRoot [red]#*#
|
|The folder to storeEntity the agent's configuration and runtime files. For example, '/storage/esthesis'.

|tags
|
|A comma-separated list of tags for the device to present during registration.

|topicPing
|**esthesis/ping**
|The MQTT topic to send PING messages.

|topicTelemetry
|**esthesis/telemetry**
|The MQTT topic to send TELEMETRY messages.

|topicMetadata
|**esthesis/metadata**
|The MQTT topic to send METADATA messages.

|topicControlRequest
|**esthesis/control/request**
|The MQTT topic to listen for CONTROL REQUEST messages.

|topicControlReply
|**esthesis/control/reply**
|The MQTT topic to send CONTROL REPLY messages.

|skipInitialProvisioning
|**true**
| A flag for the device to skip initial provisioning, useful in case the device comes with a firmware image already installed during factory setup.

|skipRegistration
|**false**
|A flag indicating to skip the initial device registration with _esthesis_ platform, useful if you ship
devices already registered.

|supportedCommands
|**PROVISIONING_CHECK_NEW,
PING,
HEALTH,
REBOOT,
EXECUTE**
|A comma-separated list of commands this device supports.
|===

.Communication parameters
[cols="1,^,1"]
|===
|Parameter |Value |Description

|requestAttempts
|**100**
|The maximum number a request (to esthesis platform) is retried.

|requestMaxBackoff
|**60**
|The maximum number of minutes to wait between attempts of previously failed requests.

|requestRetryBackoff
|**1000**
|Number of milliseconds to wait before trying again a previously failed request.

|===

.Local services
[cols="1,^,1"]
|===
|Parameter |Value |Description

|proxyMqtt
|true, **false**
|A flag to indicate that the embedded MQTT-to-MQTT proxy server should be started.

|proxyMqttPort
|**4566**
|The port of the embedded proxy MQTT server.

|proxyWeb
|true, **false**
|A flag to indicate that the embedded web-to-MQTT proxy server should be started.

|proxyWebPort
|**4567**
|The port of the embedded proxy Web server.

|===

.Security parameters
[cols="1,^,1"]
|===
|Parameter |Value |Description

|asymmetricCipher
|**RSA/ECB/PKCS1Padding**
|The cipher used for asymmetric encryption/decryption

|asymmetricKeyAlgorithm
|**RSA**
|The algorithm the asymmetric keys (i.e. public and private keys) are created with.

|Whether incoming messages should be encrypted.
|true, **false**
|A flag indicating whether incoming messages should be encrypted.

|incomingSigned
|true, **false**
|A flag indicating whether incoming messages should be signed.

|outgoingEncrypted
|true, **false**
|A falg indicating whether outgoing messages are encrypted.

|outgoingSigned
|true, **false**
|A flag indicating whether outgoing messages are signed.

|provisioningEncrypted
|true, **false**
|A flag indicating whether incoming provisioning packages should be encrypted.

|provisioningSigned
|true, **false**
|A flag indicating whether incoming provisioning packages should be signed.

|signatureAlgorithm
|**SHA256withRSA**
|The algorithm to be used when signing messages.

|symmetricCipher
|**AES/CBC/PKCS5Padding**
|The cipher used for symmetric encryption/decryption.

|symmetricKeyAlgorithm
|AES
|The algorithm the symmetric key (i.e. the session key) is created with.

|===

.Health checks parameters
[cols="1,^,1"]
|===
|Parameter |Value |Description

|healthDataFreqMsec
|**3600000**
|How often health data from the node are transmitted back to the platform (in msec).

|healthDataInitialDelayMsec
|**3600000**
|How long to wait before starting transmitting health data (in msec).

|pingFreqMsec
|60000
|How often PING data is sent (in msec).

|pingInitialDelayMsec
|60000
|How long to wait before start sending ping data (in msec).

|hcOsManufacturer
|**true**, false
|Return manufacturer information in health messages.

|hcOsVersion
|**true**, false
|Return OS version information in health messages.

|hcHwSerial
|**true**, false
|Return hardware serial number information in health messages.

|hcCpuPhysicalPackage
|**true**, false
|Return the number of CPUs information in health messages.

|hcCpuPhysicalCores
|**true**, false
|Return the number of physical CPU cores information in health messages.

|hcCpuLogicalCores
|**true**, false
|Return the number of logical CPU cores information in health messages.

|hcCpuIdentifier
|**true**, false
|Return the CPU identifier information in health messages.

|hcCpuProcessorId
|**true**, false
|Return the CPU processor ID information in health messages

|hcCpuTemperature
|**true**, false
|Return the CPU temperature information in health messages.

|hcMemoryAvailable
|**true**, false
|Return the available memory information in health messages.

|hcMemoryTotal
|**true**, false
|Return the total memory information in health messages.

|hcLoad1
|**true**, false
|Return the load in the last 1' information in health messages.

|hcLoad5
|**true**, false
|Return the load in the last 5' information in health messages.

|hcLoad15
|**true**, false
|Return the load in the last 15' information in health messages.

|hcFs
|**true**, false
|Return information about filesystems usage in health messages.

|hcFilterFs
|
|A comma-separated list of filestystems to include in health messages. If left empty, all
discovered filesystems will be included.

|hcCurrentTime
|**true**, false
|Return the device's local clock date/time.

|hcUpTime
|**true**, false
|Returns the device's uptime in health messages.

|hcIpAddress
|**true**, false
|Returns the device's IP address in health messages.

|hcIpIfFilter
|
|A comma-separated list of interface names to include when reporting their IP address. If left
empty, all interfaces will be included.

|runtimeVersion
|**true**, false
|Returns the device's agent version in health messages.

|runtimeCommitId
|**true**, false
|Returns the commit ID of the runtime agent running on the device in health messages.

|firmwareVersionFile
|
|A file containing the firmware version to be reported. The contents of this file are read by the
agent and reported in health checks.
|===

[[demo-parameters]]
.Demo parameters
[cols="1,^,1"]
|===
|Parameter |Value |Description

|demo
|true, **false**
|A flag instructing the agent to submit random telemetry data.

|demoFreqMsec
|**5000**
|The period in which random data is generated and sent (in msec).

|demoInitialDelayMsec
|**5000**
|The amount of time to wait before the agent starts submitting random data (in msec).

|demoPayload
|{`"m": "demo", "v": { "temperature": %i%, "humidity": %f%}`
|The payload of the random data (see also <<dev-device-simulator>>).
|===

== Embedded servers

The device agent embeds a locally-exposed Web server and an MQTT server.
These local servers act like a proxy between your device's custom software and the esthesis back-end platform, providing a communication channel to transmit your device/sensor data.

Once you have collected data by any custom method/software running in your device, you can utilise the embedded device agent servers to let _esthesis_ transfer them to the _esthesis_ server and then using the configured Data Writers forward them to your back-end infrastructure.
Your custom software does not need to be aware of URLs, IP address, or any other infrastructure-related information that might change.
It only needs to communicate with the servers being exposed locally by the device agent using `localhost` or `127.0.0.1`.
It is then the responsibility of the device agent to get your payload and forward it.

=== Embedded Web server

The embedded web server listens, by default, on port 4567 (the port can be changed in device agents' configuration parameters).
You can push your own payload to the embedded web server in the following two channels:

- /telemetry
- /metadata

For example, to push real-time telemetry data from your device you can execute:

```
curl -X POST 127.0.0.1:4567/telemetry \
-H 'Content-Type: application/json'
-d '{"m":"temperature", "v":{"sensor1": 12}}'
```

Respectively, to push real-time metadata data from your device you can execute:

```
curl -X POST 127.0.0.1:4567/metadata \
-H 'Content-Type: application/json'
-d '{"m":"ipAddress", "v":{"ip": 192.168.1.2}}'
```

=== Embedded MQTT server

The embedded MQTT server listens, by default, on port 4566 (the port can be changed in device agents' configuration parameters).
You can push your own payload to the embedded MQTT server in the following channels:

(tbc)
