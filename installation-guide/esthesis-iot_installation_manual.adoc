= esthesis IoT - Installation Guide
Doc Writer <esthesis@eurodyn.com>
:toc:
:toclevels: 2
:homepage: https://esthesis.com
:icons: font
:sectanchors:
:sectlinks:

_esthesis_ is a modern Internet of Things platform, providing end-to-end management services
for your devices. It consists of device management functionality, over-the-air firmware upgrade
services, and a modular data-management approach.

== Installation
Installation is based on public Docker containers, so you can setup your own _esthesis_ environment
quickly and with minimal effort. You can install _esthesis_ in a Docker Engine, in a Kubernetes cluster,
or in an OCP cluster.

_esthesis_ requires a variety of third-party support services to be available to operate properly. These
services can be deployed as part of _esthesis_' own deployment or you can opt to skip them to provide
your own instances. For example, _esthesis_ requires an InfluxDB to store time-series data and will
setup one as part of the default installation process. However, in case you already have a running
InfluxDB, you can skip the default installation of InfluxDB and point _esthesis_ to use the one you
already have in place.

.Supporting services
The list of supporting services required by _esthesis_ include:

* **A MySQL database**, acting as the main database of the platform. It stores information about the
devices, users, provisioning packages, etc. This database does not store any device telemetry data.
* **An Apache NiFi instance**, acting as the data orchestration layer.
* **An Eclipse Mosquitto MQTT server**, providing the necessary infrastructure for device communication.
* **An InfluxDB database**, to store device telemetry data.
* **An NGINX reverse proxy**, to expose _esthesis_ services without providing direct access to the
_esthesis_ backend server.

.Main services
The main services of _esthesis_ platform consist of:

* **esthesis platform backend server**, the server component of the platform.
* **esthesis platform frontend**, a web-based frontend for users to manage the platform.

=== Installation options

==== Docker
===== All-in-one installation
This installation is the quickest way to go from an empty system to a fully-functional _esthesis_
platform in just a few minutes. It will create, link and configure all necessary Docker
containers to provide all the support and main services for you.

You can perform an all-in-one installation issuing the following command:

```
curl -Ls https://raw.githubusercontent.com/esthesisiot/esthesis-setup/master/docker/docker-compose.yml |
docker compose -f /dev/stdin up -d
```

===== Selective services only installation
You can specify which specific services of _esthesis_ you need in your installation by taking advantage
of Docker Compose's built-in functionality to only start specific services. For example, if you want
to use your own resources instead of _esthesis_ 'supporting services' and only install _esthesis_
main services, you can substitute `docker compose -f /dev/stdin up -d` above with:

```
docker compose -f /dev/stdin up -d esthesis-platform-backend-server esthesis-platform-ui
```


==== Kubernetes
TBC

==== OCP
TBC

=== Post-installation steps
==== Check containers status
As soon as all Docker containers have been initialised you can start using _esthesis_. You can monitor the status of your deployment using:

```
docker ps --format 'table {{.Names}}\t{{.Status}}' | grep esthesis
```

Before all containers ready:

image::images/image-2020-12-02-15-41-53-256.png[]

After all containers ready:

image::images/image-2020-12-02-16-36-07-141.png[]

Once all containers are reported as `healthy` you can login to _exthesis_.

==== Web location and admin account
Using the default configuration options of _esthesis_, the frontend application is available on
port 80 of your Docker Engine host. For example, http://my-esthesis-host.

The default administration credentials are:
```
Username: admin@esthes.is
Password: admin
```

WARNING: You should change the default credentials as soon as possible to prevent unauthorised access to your platform.

== Quick start
image::images/image-2020-11-25-16-59-02-520.png[Login screen]
This section will guide you through some basic configuration options once you have a new installation
of _esthesis_ up and running. Please take into account that the configuration options presented here are
probably not what you should be using in production, so you may need to tweak them to your
organisation's requirements before you expose _esthesis_ services to untrusted networks.

=== Create a certificate authority
image::images/image-2020-12-03-18-46-36-611.png[alt="Creating a certificate authority"]
* Navigate to `Certificate Authorities`.
* Create a new certificate authority, leaving the `Parent CA` option empty.

=== Create a platform certificate
image::images/image-2020-12-03-18-47-35-834.png[alt="Creating a certificate"]
* Navigate to `Certificates`.
* Create a new certificate choosing the certificate authority created above as `Signed by`.

=== Platform settings - security
image::images/image-2020-12-03-18-48-16-642.png[]
* Navigate to `Settings` > `Security`.
* Set the Platform certificate to the certificate you created above.

=== Platform settings - Device registration
image::images/image-2020-12-03-18-48-47-242.png[]
* Navigate to `Settings` > `Device registration`.
* Set Registration mode to `Open registration`.
* Set Root Certificate Authority to the one you created above.

=== Platform settings - Provisioning
image::images/image-2020-12-03-18-50-56-177.png[]

* Navigate to `Settings` > `Provisioning`.
* Set Provisioning URL to the address where _esthesis_ platform proxy container is accessible from.

=== Create a tag
image::images/image-2020-12-03-18-54-31-746.png[]
* Navigate to `Tags`.
* Create a tag you can associate resources with.

=== Register and synchronise NiFi
image::images/image-2020-12-03-18-55-03-693.png[]
* Navigate to `Infrastructure` > `NiFi`.
* Register the NiFi server to be used by _esthesis_.
* Once NiFi is registered, open on the newly created instance and click on `Synchronise`. Synchronisation
will take a few seconds; you can monitor the progress bar on top of your screen. Once synchronisation
is completed, you will be automatically redirected back to the list of NiFi servers.

=== Register the MQTT server
image::images/image-2020-12-03-18-57-55-497.png[]
* Navigate to `Infrastructure` > `MQTT`.
* Register the MQTT server to be used by _esthesis_, associating it with the tag you created before.

=== Setup Data sinks
image::images/image-2020-12-03-18-59-41-472.png[]
For the purpose of a quick setup, the Data Wizards functionality will be used.

* Navigate to `Data Wizards`.
* Select `Standard infrastructure` and click on `Next`.
* Fill-in the standard infrastructure data wizard form. If you have installes _esthesis_ using the
provided Docker Compose file, you only need to change the address of your Docker engine and leave
the remaining values to their default values.
* Click on `Execute Wizard'. Once the progress bar is completed, your installation is fully configured.

=== Register a demo device
You can, optionally, register a demo device before you start using your real devices. _esthesis_
<<_device_agent>> is provided as a Docker container (on top of a standalone agent format), so you can use it to quickly fire up a virtual demo device. To start your demo device, issue a command similar
to:
```
docker run --name esthesis-demo-device --network=esthesis_esthesis-prod -d  \
-e hardwareId=device1 \
-e storageRoot="/app" \
-e tags=test1 \
-e registrationUrl="http://my-esthesis-host:port" \
esthesis/esthesis-platform-device:latest
```

The demo device can also send random data, if configured accordingly. For demo data configuration see
<<dev-device-simulator>>.

To enable debug output on your demo device, you can add the following parameter:
```
-e logging.level.esthesis=trace
```
